plugins {
    id "java"
    id "org.javamodularity.moduleplugin" version "$modulePlugin"
    id "application"
    id "org.openjfx.javafxplugin" version "$jfxPlugin"
    id "org.beryx.jlink" version "$jlink"
    id "org.graalvm.buildtools.native" version "$nativeBuildTool"
    id "io.freefair.lombok" version "$lombokPlugin"
    id "com.github.mrcjkb.module-finder" version "0.0.7"
}

apply plugin: "java"

project.description = "Zenmart ERP - Fintech Software."
project.ext.buildDate = LocalDate.now()
project.version = "$spoty"

repositories {
    mavenLocal()
    mavenCentral()
    gradlePluginPortal()
    maven { url "https://jitpack.io" }
    maven {
        url "https://sandec.jfrog.io/artifactory/repo"
    }
}

graalvmNative {
    binaries.all {
        resources.autodetect()
    }
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = "UTF-8"
}

application {
    mainModule = "spoty.core"
    mainClass = "inc.nomard.spoty.core.Main"
}

//graalvmNative {
//    toolchainDetection = true
//    binaries {
//        main {
//            javaLauncher = javaToolchains.launcherFor {
//                languageVersion = JavaLanguageVersion.of(17)
//                vendor = JvmVendorSpec.matching("Oracle Corporation")
//            }
//        }
//    }
//}

test {
    useJUnitPlatform()
    jvmArgs '-agentlib:native-image-agent=access-filter-file=access-filter.json,config-output-dir=target/classes/META-INF/native-image'
}

run {
    jvmArgs = [
            "-XX:NewRatio=1",
            "-Xms256m",
            "-Xmx1G",
            "-XX:ReservedCodeCacheSize=512m",
            "-XX:+UseG1GC",
            "-XX:SoftRefLRUPolicyMSPerMB=50",
            "-XX:CICompilerCount=2",
            "-XX:+HeapDumpOnOutOfMemoryError",
            "-Dsun.io.useCanonCaches=false",
            "-Djbr.catch.SIGABRT=true",
            "-Djdk.attach.allowAttachSelf=true",
            "-agentlib:native-image-agent=config-output-dir=target/classes/META-INF/native-image",
    ]
}

jar {
    manifest {
        attributes(
                "Main-Class": "inc.nomard.spoty.Main"
        )
    }
}

jlink {
    addExtraDependencies(
            "javafx",
            "jakarta.inject",
            "org.jetbrains.annotations",
            "com.dlsc.gemsfx:gemsfx",
            "eu.hansolo.fx:charts",
            "com.calendarfx:view",
            ":utils"
    )
    imageZip = project.file("${buildDir}/distributions/app-${javafx.platform.classifier}.zip")
    options = ["--strip-debug", "--compress", "2", "--no-header-files", "--no-man-pages"]
    launcher {
        name = "Zenmart ERP"
        jvmArgs = [
                "-XX:NewRatio=1",
                "-Xms256m",
                "-Xmx1G",
                "-XX:ReservedCodeCacheSize=512m",
                "-XX:+UseG1GC",
                "-XX:SoftRefLRUPolicyMSPerMB=50",
                "-XX:CICompilerCount=2",
                "-XX:+HeapDumpOnOutOfMemoryError",
                "-Dsun.io.useCanonCaches=false",
                "-Djbr.catch.SIGABRT=true",
                "-Djdk.attach.allowAttachSelf=true",
                "-XX:ErrorFile=/home/infinite-dev/IdeaProjects/spoty/error%p.log",
                "-agentlib:native-image-agent=config-output-dir=target/classes/META-INF/native-image",
        ]
    }

    jpackage {
        installerOptions = [
                "--name", "Zenmart-ERP",
                "--description", project.description,
                "--app-version", project.version,
                "--copyright", "Copyright 2024 nomard inc",
                "--vendor", "Nomard Inc",
                "--icon", "src/main/resources/icon.png",
                "--type", "rpm",
                // Windows Only
//                "--win-dir-chooser",
//                "--win-menu", "--win-shortcut",
//                "--win-dir-chooser", "--win-menu",
//                "--win-per-user-install", "--win-shortcut-prompt",
        ]
    }
}

tasks.register("doPackageAll") {
    doLast {
        if (Os.isFamily(Os.FAMILY_UNIX)) {
            exec {
                mkdir("$buildDir/distributions")
                executable "$projectDir/scripts/JLinkPackage.sh"
                args = ["$buildDir"]
            }
        }
    }
}

jlinkZip.doLast {
    doPackageAll
}

dependencies {
    implementation project(":network_bridge")
    implementation project(":utils")
    implementation 'jakarta.inject:jakarta.inject-api:2.0.1'
    implementation "javax.measure:unit-api:$measure_unit_api"
    implementation "com.dlsc.gemsfx:gemsfx:$gemsfx"
//    implementation "com.github.iAmGio:froxty:1.4.0"
    implementation "com.calendarfx:view:11.12.7"
    implementation "eu.hansolo.fx:charts:$fx_charts"
//    implementation "io.soabase.record-builder:record-builder-core:39"
    implementation "io.github.mkpaz:atlantafx-parent:2.0.1"
    implementation "io.github.mkpaz:atlantafx-styles:2.0.1"
    implementation "io.github.mkpaz:atlantafx-base:2.0.1"
    implementation "com.google.code.gson:gson:2.10.1"
    compileOnly "org.projectlombok:lombok"
    annotationProcessor "org.projectlombok:lombok"
    implementation "org.projectlombok:lombok:$lombok"
    implementation "io.github.palexdev:materialfx:$materialfx"
    implementation "org.kordamp.ikonli:ikonli-javafx:$ikonLi"
    implementation "org.kordamp.ikonli:ikonli-core:$ikonLi"
    implementation "org.kordamp.ikonli:ikonli-fontawesome5-pack:$ikonLi"
    implementation "fr.brouillard.oss:cssfx:$cssfx"
    implementation "io.github.palexdev:virtualizedfx:$virtualizedFX" // update to version -> 21.1.0 breaks the system.
    implementation "io.github.palexdev:mfxcomponents:$mfxComponents"
    implementation "org.junit.jupiter:junit-jupiter-api:$junit"
    implementation "org.junit.jupiter:junit-jupiter-engine:$junit"
}
